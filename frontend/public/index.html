<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Encrypted Player Registry · Zama FHEVM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Required for Relayer WASM (SharedArrayBuffer) -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />

    <!-- Fonts: clean sci-fi look -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Sora:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg-0: #020617;
        --bg-1: #020617;
        --bg-2: #020617;
        --accent: #38bdf8;
        --accent-soft: rgba(56, 189, 248, 0.16);
        --accent-strong: rgba(56, 189, 248, 0.5);
        --danger: #fb7185;
        --danger-soft: rgba(248, 113, 113, 0.14);
        --ok: #4ade80;
        --ok-soft: rgba(74, 222, 128, 0.12);
        --text-main: #e5e7eb;
        --text-soft: #9ca3af;
        --panel: #020617;
        --panel-line: rgba(148, 163, 184, 0.3);
        --radius-xl: 22px;
        --radius-lg: 18px;
        --radius-pill: 999px;
        --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.65);
        --font-main: "Space Grotesk", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        --font-alt: "Sora", system-ui, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      body {
        font-family: var(--font-main);
        color: var(--text-main);
        background:
          radial-gradient(circle at 0% 0%, #0f172a 0, transparent 55%),
          radial-gradient(circle at 100% 0%, #0369a1 0, transparent 55%),
          radial-gradient(circle at 50% 90%, #4c1d95 0, transparent 55%),
          linear-gradient(180deg, var(--bg-1), var(--bg-2));
        background-attachment: fixed;
      }

      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .app-shell {
        max-width: 1120px;
        width: 100%;
        margin: 0 auto;
        padding: 20px 16px 32px;
      }

      /* ---------- Header ---------- */

      .app-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.22), transparent 60%),
          radial-gradient(circle at 100% 0, rgba(129, 140, 248, 0.25), transparent 60%),
          rgba(15, 23, 42, 0.82);
        box-shadow: var(--shadow-soft);
        position: sticky;
        top: 12px;
        z-index: 20;
        backdrop-filter: blur(16px);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .brand-logo {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        background:
          conic-gradient(
            from 210deg,
            rgba(56, 189, 248, 1),
            rgba(129, 140, 248, 0.1),
            rgba(244, 114, 182, 0.7),
            rgba(56, 189, 248, 1)
          );
        display: grid;
        place-items: center;
        box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.95), 0 0 24px rgba(56, 189, 248, 0.7);
      }

      .brand-logo span {
        font-family: var(--font-alt);
        font-weight: 700;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: #0b1020;
      }

      .brand-meta {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .brand-title {
        font-size: 16px;
        font-weight: 600;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .brand-subtitle {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--text-soft);
        letter-spacing: 0.18em;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .badge-pill {
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.45);
        padding: 4px 10px;
        font-size: 11px;
        color: var(--text-soft);
        display: flex;
        align-items: center;
        gap: 6px;
        background: rgba(15, 23, 42, 0.8);
      }

      .badge-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--accent);
        box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.25);
      }

      .btn {
        border-radius: var(--radius-pill);
        border: 1px solid transparent;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 600;
        font-family: var(--font-main);
        cursor: pointer;
        background: transparent;
        color: var(--text-main);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.15s ease-out;
      }

      .btn-ghost {
        border-color: rgba(148, 163, 184, 0.5);
        background: radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.2), transparent 60%),
          rgba(15, 23, 42, 0.9);
      }

      .btn-ghost:hover {
        transform: translateY(-1px);
        border-color: rgba(248, 250, 252, 0.9);
      }

      .btn-primary {
        border-color: rgba(56, 189, 248, 0.7);
        background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.55), transparent 60%),
          linear-gradient(135deg, #0ea5e9, #6366f1);
        color: #0b1020;
        box-shadow: 0 10px 26px rgba(15, 23, 42, 0.75);
      }

      .btn-primary:hover {
        transform: translateY(-1px) scale(1.01);
        box-shadow: 0 16px 38px rgba(15, 23, 42, 0.9);
      }

      .btn:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* ---------- Main content ---------- */

      .app-main {
        margin-top: 22px;
      }

      .hero {
        display: grid;
        grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
        gap: 24px;
        margin-bottom: 24px;
      }

      @media (max-width: 900px) {
        .hero {
          grid-template-columns: minmax(0, 1fr);
        }

        .app-header {
          flex-direction: column;
          align-items: stretch;
        }

        .header-right {
          justify-content: space-between;
        }
      }

      .hero-copy {
        padding: 18px 2px;
      }

      .hero-kicker {
        font-size: 11px;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--text-soft);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
      }

      .hero-kicker::before {
        content: "";
        width: 36px;
        height: 1px;
        background: linear-gradient(90deg, rgba(148, 163, 184, 0.1), rgba(148, 163, 184, 0.7));
      }

      .hero-title {
        font-size: clamp(26px, 3vw, 32px);
        font-weight: 600;
        letter-spacing: -0.03em;
        margin: 0 0 6px;
      }

      .hero-title span {
        background: linear-gradient(120deg, #38bdf8, #a855f7, #22c55e);
        -webkit-background-clip: text;
        color: transparent;
      }

      .hero-lead {
        font-size: 13px;
        max-width: 460px;
        color: var(--text-soft);
      }

      .hero-metadata {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 14px;
      }

      .chip {
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.4);
        padding: 5px 11px;
        font-size: 11px;
        color: var(--text-soft);
        background: rgba(15, 23, 42, 0.92);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .chip-label {
        text-transform: uppercase;
        letter-spacing: 0.12em;
        font-size: 10px;
        color: rgba(148, 163, 184, 0.95);
      }

      .hero-panel {
        border-radius: var(--radius-xl);
        border: 1px solid rgba(148, 163, 184, 0.5);
        background:
          radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.25), transparent 55%),
          radial-gradient(circle at 100% 120%, rgba(168, 85, 247, 0.35), transparent 55%),
          rgba(15, 23, 42, 0.96);
        box-shadow: var(--shadow-soft);
        padding: 16px 16px 14px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        position: relative;
        overflow: hidden;
      }

      .hero-panel::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.28), transparent 60%);
        mix-blend-mode: soft-light;
        opacity: 0.7;
        pointer-events: none;
      }

      .hero-panel-inner {
        position: relative;
        z-index: 1;
      }

      .hero-panel-title {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: rgba(226, 232, 240, 0.9);
        margin-bottom: 4px;
      }

      .hero-panel-address {
        font-family: var(--font-alt);
        font-size: 12px;
        padding: 8px 10px;
        border-radius: var(--radius-lg);
        border: 1px dashed rgba(148, 163, 184, 0.6);
        background: rgba(15, 23, 42, 0.8);
        word-break: break-all;
      }

      .hero-panel-status {
        margin-top: 6px;
        font-size: 12px;
        color: var(--text-soft);
      }

      .hero-panel-mini {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 10px;
        font-size: 11px;
        color: var(--text-soft);
      }

      /* ---------- Panels grid ---------- */

      .grid {
        display: grid;
        grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.1fr) minmax(0, 1.1fr);
        gap: 18px;
      }

      @media (max-width: 1100px) {
        .grid {
          grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        }
      }

      @media (max-width: 800px) {
        .grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .panel {
        border-radius: var(--radius-xl);
        border: 1px solid rgba(148, 163, 184, 0.45);
        background:
          radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.16), transparent 60%),
          rgba(15, 23, 42, 0.96);
        box-shadow: var(--shadow-soft);
        padding: 16px 16px 18px;
        position: relative;
        overflow: hidden;
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 10px;
      }

      .panel-title {
        font-size: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .panel-tag {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--text-soft);
      }

      .panel-body {
        font-size: 13px;
      }

      .panel-hint {
        font-size: 11px;
        color: var(--text-soft);
        margin-bottom: 8px;
      }

      .panel-hint strong {
        color: rgba(248, 250, 252, 0.9);
      }

      .panel-section {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed rgba(148, 163, 184, 0.3);
      }

      .panel-section-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: rgba(148, 163, 184, 0.9);
        margin-bottom: 6px;
      }

      /* ---------- Form controls ---------- */

      .field {
        margin-bottom: 9px;
      }

      .field-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--text-soft);
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .field-label span.value {
        font-family: var(--font-alt);
        font-size: 11px;
        color: rgba(226, 232, 240, 0.9);
      }

      .field-input {
        display: block;
        width: 100%;
        border-radius: var(--radius-lg);
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(15, 23, 42, 0.92);
        padding: 10px 12px;
        font-family: var(--font-main);
        font-size: 13px;
        color: var(--text-main);
        outline: none;
        transition: all 0.12s ease-out;
      }

      .field-input::placeholder {
        color: rgba(156, 163, 175, 0.8);
      }

      .field-input:focus {
        border-color: rgba(56, 189, 248, 0.75);
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.35), 0 0 0 5px rgba(15, 23, 42, 0.9);
      }

      .field-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .field-row > .field {
        flex: 1 1 120px;
      }

      .btn-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 6px;
      }

      /* ---------- Status & output ---------- */

      .status-bubble {
        margin-top: 8px;
        font-size: 11px;
        padding: 7px 10px;
        border-radius: var(--radius-lg);
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.9);
        color: var(--text-soft);
        min-height: 30px;
      }

      .status-bubble.ok {
        border-color: rgba(74, 222, 128, 0.6);
        background: var(--ok-soft);
        color: rgba(220, 252, 231, 0.96);
      }

      .status-bubble.err {
        border-color: rgba(248, 113, 113, 0.9);
        background: var(--danger-soft);
        color: rgba(254, 226, 226, 0.94);
      }

      .pill-output {
        margin-top: 6px;
        font-family: var(--font-alt);
        font-size: 11px;
        border-radius: var(--radius-pill);
        border: 1px dashed rgba(148, 163, 184, 0.6);
        padding: 6px 10px;
        background: rgba(15, 23, 42, 0.9);
        word-break: break-all;
        color: rgba(226, 232, 240, 0.92);
      }

      .pill-output span.label {
        color: var(--text-soft);
        text-transform: uppercase;
        letter-spacing: 0.16em;
        font-size: 9px;
        margin-right: 8px;
      }

      .age-display {
        margin-top: 8px;
        padding: 8px 10px;
        border-radius: var(--radius-lg);
        border: 1px solid rgba(56, 189, 248, 0.6);
        background: rgba(15, 23, 42, 0.98);
        font-size: 13px;
        display: inline-flex;
        align-items: baseline;
        gap: 6px;
      }

      .age-display span.value {
        font-size: 18px;
        font-weight: 600;
        color: #f9fafb;
      }

      .age-display span.unit {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: rgba(148, 163, 184, 0.9);
      }

      .owner-locked {
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.94));
        backdrop-filter: blur(4px);
        display: grid;
        place-items: center;
        pointer-events: none;
      }

      .owner-locked-inner {
        text-align: center;
        max-width: 260px;
        font-size: 12px;
        color: var(--text-soft);
      }

      .owner-locked-inner strong {
        color: rgba(248, 250, 252, 0.94);
      }

      .footer-note {
        margin-top: 24px;
        font-size: 11px;
        color: rgba(148, 163, 184, 0.85);
        text-align: center;
        letter-spacing: 0.16em;
        text-transform: uppercase;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="app-shell">
        <!-- Header -->
        <header class="app-header">
          <div class="brand">
            <div class="brand-logo"><span>FHE</span></div>
            <div class="brand-meta">
              <div class="brand-title">Encrypted Player Registry</div>
              <div class="brand-subtitle">Zama · FHEVM · Sepolia</div>
            </div>
          </div>
          <div class="header-right">
            <div class="badge-pill">
              <span class="badge-dot"></span>
              <span id="networkLabel">Disconnected</span>
            </div>
            <button id="btnConnect" class="btn btn-primary">
              <span>Connect wallet</span>
            </button>
          </div>
        </header>

        <!-- Hero -->
        <main class="app-main">
          <section class="hero">
            <div class="hero-copy">
              <div class="hero-kicker">Private profiles on-chain</div>
              <h1 class="hero-title">
                Register players with <span>encrypted age</span>, readable only by them.
              </h1>
              <p class="hero-lead">
                Names stay public for leaderboards and UX, while ages are kept encrypted under Zama’s
                FHEVM. Players can decrypt their own age through the Relayer SDK.
              </p>
              <div class="hero-metadata">
                <div class="chip">
                  <span class="chip-label">Contract</span>
                  <span id="contractShort">–</span>
                </div>
                <div class="chip">
                  <span class="chip-label">Relayer SDK</span>
                  <span>0.2.0</span>
                </div>
                <div class="chip">
                  <span class="chip-label">Network</span>
                  <span>Sepolia (FHEVM)</span>
                </div>
              </div>
            </div>

            <aside class="hero-panel">
              <div class="hero-panel-inner">
                <div class="hero-panel-title">Registry endpoint</div>
                <div class="hero-panel-address" id="contractAddressBox"></div>
                <div class="hero-panel-status" id="connectionStatus">
                  Waiting for wallet connection…
                </div>
                <div class="hero-panel-mini">
                  <span id="ownerInfo">Owner: –</span>
                  <span id="accountInfo">Account: –</span>
                </div>
              </div>
            </aside>
          </section>

          <!-- Grid: Player / Profile / Owner -->
          <section class="grid">
            <!-- Player registration -->
            <article class="panel">
              <div class="panel-header">
                <div class="panel-title">
                  Player onboarding
                  <span class="panel-tag">Encrypted registration</span>
                </div>
              </div>
              <div class="panel-body">
                <p class="panel-hint">
                  Choose a public display name and a private age. The age is encrypted in the browser
                  using the Relayer SDK and stored as ciphertext on-chain.
                </p>

                <div class="panel-section">
                  <div class="panel-section-title">New / update (encrypted)</div>
                  <div class="field">
                    <label class="field-label" for="regName">
                      Name
                      <span class="value">visible</span>
                    </label>
                    <input
                      id="regName"
                      class="field-input"
                      type="text"
                      maxlength="64"
                      placeholder="E.g. neon-fox, alice.wonder..."
                    />
                  </div>

                  <div class="field-row">
                    <div class="field">
                      <label class="field-label" for="regAge">
                        Age
                        <span class="value">0 – 255</span>
                      </label>
                      <input
                        id="regAge"
                        class="field-input"
                        type="number"
                        min="0"
                        max="255"
                        placeholder="E.g. 27"
                      />
                    </div>
                  </div>

                  <div class="btn-row">
                    <button id="btnRegisterEnc" class="btn btn-primary">Encrypt & register</button>
                    <button id="btnRegisterPlain" class="btn btn-ghost">
                      Dev only: plain age
                    </button>
                  </div>

                  <div id="registerStatus" class="status-bubble">
                    Fill the form and submit an encrypted registration.
                  </div>
                </div>
              </div>
            </article>

            <!-- My profile -->
            <article class="panel">
              <div class="panel-header">
                <div class="panel-title">
                  My profile
                  <span class="panel-tag">Handles & decryption</span>
                </div>
              </div>
              <div class="panel-body">
                <p class="panel-hint">
                  Fetch your on-chain profile, inspect the encrypted age handle, and locally decrypt
                  your age using EIP-712 and the Relayer.
                </p>

                <div class="panel-section">
                  <div class="panel-section-title">On-chain view</div>

                  <div class="btn-row">
                    <button id="btnRefreshProfile" class="btn btn-ghost">Load my profile</button>
                  </div>

                  <div id="profileStatus" class="status-bubble">
                    Not loaded yet. Click “Load my profile” after registration.
                  </div>

                  <div id="profileNameBox" class="pill-output" style="margin-top: 6px;">
                    <span class="label">Name</span>
                    <span id="profileNameValue">–</span>
                  </div>

                  <div id="profileHandleBox" class="pill-output">
                    <span class="label">Age handle</span>
                    <span id="profileHandleValue">–</span>
                  </div>
                </div>

                <div class="panel-section">
                  <div class="panel-section-title">Profile updates</div>
                  <div class="field">
                    <label class="field-label" for="updateName">New display name</label>
                    <input
                      id="updateName"
                      class="field-input"
                      type="text"
                      maxlength="64"
                      placeholder="Update only the name…"
                    />
                  </div>
                  <div class="btn-row">
                    <button id="btnUpdateName" class="btn btn-ghost">Update name</button>
                  </div>

                  <div class="field-row" style="margin-top: 6px;">
                    <div class="field">
                      <label class="field-label" for="updateAge">
                        New age
                        <span class="value">encrypted</span>
                      </label>
                      <input
                        id="updateAge"
                        class="field-input"
                        type="number"
                        min="0"
                        max="255"
                        placeholder="E.g. 28"
                      />
                    </div>
                  </div>
                  <div class="btn-row">
                    <button id="btnUpdateAgeEnc" class="btn btn-ghost">
                      Encrypt & update age
                    </button>
                  </div>
                </div>

                <div class="panel-section">
                  <div class="panel-section-title">Decrypt my age</div>
                  <div class="btn-row">
                    <button id="btnDecryptAge" class="btn btn-primary">
                      Private decrypt via Relayer
                    </button>
                    <button id="btnMakeAgePublic" class="btn btn-ghost">
                      Make my age public
                    </button>
                  </div>

                  <div id="decryptStatus" class="status-bubble">
                    Your age stays private: only you can decrypt using your wallet signature.
                  </div>

                  <div id="ageDisplay" class="age-display" style="display: none;">
                    <span class="value" id="ageValue"></span>
                    <span class="unit">years</span>
                  </div>
                </div>
              </div>
            </article>

            <!-- Owner console -->
            <article class="panel">
              <div class="panel-header">
                <div class="panel-title">
                  Owner console
                  <span class="panel-tag">Moderation tools</span>
                </div>
              </div>
              <div class="panel-body">
                <p class="panel-hint">
                  Registry owner can mark ages as public for specific addresses or logically clear a
                  player profile if needed.
                </p>

                <div class="panel-section">
                  <div class="panel-section-title">Target player</div>
                  <div class="field">
                    <label class="field-label" for="ownerTarget">
                      Player address
                    </label>
                    <input
                      id="ownerTarget"
                      class="field-input"
                      type="text"
                      placeholder="0x… address to manage"
                    />
                  </div>
                  <div class="btn-row">
                    <button id="btnOwnerMakePublic" class="btn btn-ghost">
                      Make age public
                    </button>
                    <button id="btnOwnerClear" class="btn btn-ghost">
                      Clear profile
                    </button>
                  </div>

                  <div id="ownerStatus" class="status-bubble">
                    Connect as the contract owner to unlock moderation.
                  </div>
                </div>
              </div>
              <div id="ownerOverlay" class="owner-locked" style="display: none;">
                <div class="owner-locked-inner">
                  <strong>Read-only mode.</strong><br />
                  You are not the registry owner, so admin actions are disabled on this device.
                </div>
              </div>
            </article>
          </section>

          <div class="footer-note">
            Powered by Zama FHEVM · @zama-fhe/relayer-sdk@0.2.0 · Ethers v6
          </div>
        </main>
      </div>
    </div>

    <!-- Relayer SDK 0.2.0 (browser build) -->
    <script
      type="module"
      crossorigin
      src="https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js"
    ></script>

    <!-- Ethers v6 (ESM) -->
    <script
      type="module"
      crossorigin
      src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm"
    ></script>

    <!-- App logic -->
    <script type="module">
      import {
        initSDK,
        createInstance,
        SepoliaConfig,
        generateKeypair,
      } from "https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js";
      import {
        BrowserProvider,
        Contract,
      } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";

      // ---------- Config ----------
      const CONTRACT_ADDRESS = "0x76A9E52BFf4E3Ee13D3d6Bd2b703C15e0806Dc04";
      const RELAYER_URL = "https://relayer.testnet.zama.org";
      const SEPOLIA_CHAIN_ID = 11155111n;
      const SEPOLIA_CHAIN_ID_HEX = "0xaa36a7";

      const abi = [
        {
          inputs: [],
          name: "version",
          outputs: [{ internalType: "string", name: "", type: "string" }],
          stateMutability: "pure",
          type: "function",
        },
        {
          inputs: [],
          name: "owner",
          outputs: [{ internalType: "address", name: "", type: "address" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [{ internalType: "address", name: "player", type: "address" }],
          name: "isRegistered",
          outputs: [{ internalType: "bool", name: "", type: "bool" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [{ internalType: "address", name: "player", type: "address" }],
          name: "getPlayer",
          outputs: [
            { internalType: "bool", name: "exists", type: "bool" },
            { internalType: "string", name: "name", type: "string" },
            { internalType: "bytes32", name: "ageHandle", type: "bytes32" },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "getMyAgeHandle",
          outputs: [{ internalType: "bytes32", name: "", type: "bytes32" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            { internalType: "string", name: "name", type: "string" },
            { internalType: "bytes32", name: "ageExt", type: "bytes32" },
            { internalType: "bytes", name: "proof", type: "bytes" },
          ],
          name: "registerEncrypted",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            { internalType: "string", name: "name", type: "string" },
            { internalType: "uint8", name: "agePlain", type: "uint8" },
          ],
          name: "registerPlain",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [{ internalType: "string", name: "newName", type: "string" }],
          name: "updateName",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [
            { internalType: "bytes32", name: "newAgeExt", type: "bytes32" },
            { internalType: "bytes", name: "proof", type: "bytes" },
          ],
          name: "updateAgeEncrypted",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "makeMyAgePublic",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [{ internalType: "address", name: "player", type: "address" }],
          name: "makePlayerAgePublic",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [{ internalType: "address", name: "player", type: "address" }],
          name: "clearPlayer",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
      ];

      // ---------- DOM helpers ----------
      const $ = (id) => document.getElementById(id);

      const ui = {
        networkLabel: $("networkLabel"),
        btnConnect: $("btnConnect"),
        contractShort: $("contractShort"),
        contractAddressBox: $("contractAddressBox"),
        connectionStatus: $("connectionStatus"),
        ownerInfo: $("ownerInfo"),
        accountInfo: $("accountInfo"),

        // registration
        regName: $("regName"),
        regAge: $("regAge"),
        btnRegisterEnc: $("btnRegisterEnc"),
        btnRegisterPlain: $("btnRegisterPlain"),
        registerStatus: $("registerStatus"),

        // profile
        btnRefreshProfile: $("btnRefreshProfile"),
        profileStatus: $("profileStatus"),
        profileNameValue: $("profileNameValue"),
        profileHandleValue: $("profileHandleValue"),
        updateName: $("updateName"),
        btnUpdateName: $("btnUpdateName"),
        updateAge: $("updateAge"),
        btnUpdateAgeEnc: $("btnUpdateAgeEnc"),
        btnDecryptAge: $("btnDecryptAge"),
        btnMakeAgePublic: $("btnMakeAgePublic"),
        decryptStatus: $("decryptStatus"),
        ageDisplay: $("ageDisplay"),
        ageValue: $("ageValue"),

        // owner
        ownerTarget: $("ownerTarget"),
        btnOwnerMakePublic: $("btnOwnerMakePublic"),
        btnOwnerClear: $("btnOwnerClear"),
        ownerStatus: $("ownerStatus"),
        ownerOverlay: $("ownerOverlay"),
      };

      ui.contractShort.textContent = `${CONTRACT_ADDRESS.slice(
        0,
        6
      )}…${CONTRACT_ADDRESS.slice(-4)}`;
      ui.contractAddressBox.textContent = CONTRACT_ADDRESS;

      // ---------- Logging ----------
      const stamp = () => new Date().toISOString().replace("T", " ").replace("Z", "");
      const log = {
        info: (...args) => console.log(`%c[APP ${stamp()}]`, "color:#e5e7eb", ...args),
        ok: (...args) => console.log(`%c[APP ${stamp()}]`, "color:#4ade80", ...args),
        warn: (...args) => console.warn(`%c[APP ${stamp()}]`, "color:#facc15", ...args),
        err: (...args) => console.error(`%c[APP ${stamp()}]`, "color:#fb7185", ...args),
      };

      const FHELOG = {
        encStart(meta) {
          log.info("[FHE] encrypt start", meta);
        },
        encAdd(tag, val) {
          log.info("[FHE] add", tag, val);
        },
        encDone(handles, proof) {
          log.ok("[FHE] encrypt done", { handles, proofBytes: proof?.length || 0 });
        },
        userDec(meta) {
          log.info("[FHE] userDecrypt", meta);
        },
      };

      const setStatus = (el, text, mode = null) => {
        el.textContent = text;
        el.classList.remove("ok", "err");
        if (mode === "ok") el.classList.add("ok");
        if (mode === "err") el.classList.add("err");
      };

      const shortAddr = (a) =>
        !a ? "–" : `${a.slice(0, 6)}…${a.slice(-4)}`;

      const isUint8 = (n) =>
        Number.isInteger(n) && n >= 0 && n <= 255;

      // ---------- State ----------
      let provider;
      let signer;
      let account;
      let contract;
      let relayer;
      let isOwner = false;

      // ---------- Connection ----------
      async function connectWallet() {
        try {
          if (!window.ethereum) throw new Error("No injected wallet found (MetaMask, Rabby…).");

          ui.btnConnect.disabled = true;
          ui.btnConnect.textContent = "Connecting…";

          provider = new BrowserProvider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          const net = await provider.getNetwork();
          log.info("Connected network:", String(net.chainId));

          if (net.chainId !== SEPOLIA_CHAIN_ID) {
            ui.networkLabel.textContent = "Switching to Sepolia…";
            await provider.send("wallet_switchEthereumChain", [
              { chainId: SEPOLIA_CHAIN_ID_HEX },
            ]);
          }

          signer = await provider.getSigner();
          account = await signer.getAddress();

          contract = new Contract(CONTRACT_ADDRESS, abi, signer);

          ui.btnConnect.textContent = shortAddr(account);
          ui.networkLabel.textContent = "Sepolia · connected";
          ui.accountInfo.textContent = `Account: ${shortAddr(account)}`;
          setStatus(ui.connectionStatus, "Wallet connected. Initializing FHE Relayer…");

          // Init Relayer SDK
          await initSDK();
          relayer = await createInstance({
            ...SepoliaConfig,
            relayerUrl: RELAYER_URL,
            network: window.ethereum,
            debug: true,
          });
          log.ok("Relayer ready");

          // fetch owner
          try {
            const owner = await contract.owner();
            isOwner = owner.toLowerCase() === account.toLowerCase();
            ui.ownerInfo.textContent = `Owner: ${shortAddr(owner)}`;
            ui.ownerOverlay.style.display = isOwner ? "none" : "grid";
            ui.btnOwnerMakePublic.disabled = !isOwner;
            ui.btnOwnerClear.disabled = !isOwner;
          } catch (e) {
            log.warn("Failed to fetch owner()", e);
          }

          ui.btnConnect.disabled = false;
          setStatus(
            ui.connectionStatus,
            "Ready. You can register or load your profile.",
            "ok"
          );
        } catch (e) {
          log.err("connectWallet error:", e);
          setStatus(
            ui.connectionStatus,
            e.message || String(e),
            "err"
          );
          ui.btnConnect.disabled = false;
          ui.btnConnect.textContent = "Connect wallet";
        }
      }

      ui.btnConnect.addEventListener("click", connectWallet);

      // ---------- Encryption helper ----------
      async function encryptAge(ageValue) {
        if (!relayer || !account) {
          throw new Error("Relayer not initialized or wallet not connected.");
        }
        if (!isUint8(ageValue)) {
          throw new Error("Age must be in range 0…255.");
        }
        FHELOG.encStart({ contract: CONTRACT_ADDRESS, field: "age", value: ageValue });

        const input = relayer.createEncryptedInput(CONTRACT_ADDRESS, account);
        input.add8(ageValue);
        FHELOG.encAdd("add8(age)", ageValue);

        const { handles, inputProof } = await input.encrypt();
        FHELOG.encDone(handles, inputProof);

        if (!handles || !handles[0]) {
          throw new Error("No encrypted handle returned from Relayer.");
        }
        return { handle: handles[0], proof: inputProof };
      }

      // ---------- Player: register encrypted ----------
      async function registerEncrypted() {
        try {
          if (!contract || !relayer) await connectWallet();
          const name = ui.regName.value.trim();
          const ageNum = Number(ui.regAge.value);

          if (!name) throw new Error("Name cannot be empty.");
          if (!Number.isFinite(ageNum)) throw new Error("Age must be a number.");

          setStatus(ui.registerStatus, "Encrypting age…");
          const { handle, proof } = await encryptAge(ageNum);

          // Optional dry run
          try {
            await contract.registerEncrypted.staticCall(name, handle, proof);
          } catch (e) {
            log.warn("staticCall(registerEncrypted) failed, sending tx anyway:", e);
          }

          setStatus(ui.registerStatus, "Submitting transaction…");
          const tx = await contract.registerEncrypted(name, handle, proof);
          log.info("registerEncrypted tx:", tx.hash);
          await tx.wait();
          setStatus(ui.registerStatus, "Encrypted registration confirmed on-chain.", "ok");
        } catch (e) {
          log.err("registerEncrypted error:", e);
          setStatus(ui.registerStatus, e.message || String(e), "err");
        }
      }

      ui.btnRegisterEnc.addEventListener("click", () => {
        registerEncrypted();
      });

      // ---------- Player: register plain (dev helper) ----------
      async function registerPlain() {
        try {
          if (!contract) await connectWallet();
          const name = ui.regName.value.trim();
          const ageNum = Number(ui.regAge.value);

          if (!name) throw new Error("Name cannot be empty.");
          if (!isUint8(ageNum)) throw new Error("Age must be between 0 and 255.");

          setStatus(ui.registerStatus, "Submitting plain registration (dev)…");
          const tx = await contract.registerPlain(name, ageNum);
          log.info("registerPlain tx:", tx.hash);
          await tx.wait();
          setStatus(
            ui.registerStatus,
            "Plain registration confirmed. Age is encrypted on-chain by the contract.",
            "ok"
          );
        } catch (e) {
          log.err("registerPlain error:", e);
          setStatus(ui.registerStatus, e.message || String(e), "err");
        }
      }

      ui.btnRegisterPlain.addEventListener("click", () => {
        registerPlain();
      });

      // ---------- Profile: load my profile ----------
      async function loadMyProfile() {
        try {
          if (!contract || !account) await connectWallet();
          setStatus(ui.profileStatus, "Fetching profile from chain…");

          const [exists, name, ageHandle] = await contract.getPlayer(account);

          if (!exists) {
            setStatus(
              ui.profileStatus,
              "No profile found. Register first using the left panel.",
              "err"
            );
            ui.profileNameValue.textContent = "–";
            ui.profileHandleValue.textContent = "–";
            ui.ageDisplay.style.display = "none";
            return;
          }

          ui.profileNameValue.textContent = name || "(empty)";
          ui.profileHandleValue.textContent = ageHandle;
          setStatus(ui.profileStatus, "Profile loaded from chain.", "ok");
        } catch (e) {
          log.err("loadMyProfile error:", e);
          setStatus(ui.profileStatus, e.message || String(e), "err");
        }
      }

      ui.btnRefreshProfile.addEventListener("click", () => {
        loadMyProfile();
      });

      // ---------- Profile: update name ----------
      async function updateName() {
        try {
          if (!contract || !account) await connectWallet();
          const newName = ui.updateName.value.trim();
          if (!newName) throw new Error("New name cannot be empty.");

          setStatus(ui.profileStatus, "Submitting name update…");
          const tx = await contract.updateName(newName);
          log.info("updateName tx:", tx.hash);
          await tx.wait();
          setStatus(ui.profileStatus, "Name updated on-chain.", "ok");
          await loadMyProfile();
        } catch (e) {
          log.err("updateName error:", e);
          setStatus(ui.profileStatus, e.message || String(e), "err");
        }
      }

      ui.btnUpdateName.addEventListener("click", () => {
        updateName();
      });

      // ---------- Profile: update age (encrypted) ----------
      async function updateAgeEncrypted() {
        try {
          if (!contract || !relayer) await connectWallet();
          const ageNum = Number(ui.updateAge.value);
          if (!Number.isFinite(ageNum)) throw new Error("Age must be a number.");

          setStatus(ui.profileStatus, "Encrypting new age…");
          const { handle, proof } = await encryptAge(ageNum);

          try {
            await contract.updateAgeEncrypted.staticCall(handle, proof);
          } catch (e) {
            log.warn("staticCall(updateAgeEncrypted) failed, sending tx anyway:", e);
          }

          setStatus(ui.profileStatus, "Submitting age update…");
          const tx = await contract.updateAgeEncrypted(handle, proof);
          log.info("updateAgeEncrypted tx:", tx.hash);
          await tx.wait();
          setStatus(ui.profileStatus, "Encrypted age updated on-chain.", "ok");
          await loadMyProfile();
        } catch (e) {
          log.err("updateAgeEncrypted error:", e);
          setStatus(ui.profileStatus, e.message || String(e), "err");
        }
      }

      ui.btnUpdateAgeEnc.addEventListener("click", () => {
        updateAgeEncrypted();
      });

      // ---------- Profile: make my age public ----------
      async function makeMyAgePublic() {
        try {
          if (!contract) await connectWallet();
          setStatus(ui.decryptStatus, "Submitting makeMyAgePublic()…");
          const tx = await contract.makeMyAgePublic();
          log.info("makeMyAgePublic tx:", tx.hash);
          await tx.wait();
          setStatus(
            ui.decryptStatus,
            "Your age is now publicly decryptable for auditors / explorers.",
            "ok"
          );
        } catch (e) {
          log.err("makeMyAgePublic error:", e);
          setStatus(ui.decryptStatus, e.message || String(e), "err");
        }
      }

      ui.btnMakeAgePublic.addEventListener("click", () => {
        makeMyAgePublic();
      });

      // ---------- Profile: decrypt my age (userDecrypt) ----------
      async function decryptMyAge() {
        try {
          if (!contract || !relayer || !account) await connectWallet();

          setStatus(ui.decryptStatus, "Requesting encrypted handle…");
          const handle = await contract.getMyAgeHandle();
          if (!handle || handle === "0x0000000000000000000000000000000000000000000000000000000000000000") {
            throw new Error("No encrypted age found for this account.");
          }

          FHELOG.userDec({ handle });

          const keypair = await generateKeypair();
          const startTs = Math.floor(Date.now() / 1000).toString();
          const daysValid = "7";

          const eip = relayer.createEIP712(
            keypair.publicKey,
            [CONTRACT_ADDRESS],
            startTs,
            daysValid
          );
          const sig = await signer.signTypedData(
            eip.domain,
            { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification },
            eip.message
          );

          const pairs = [{ handle, contractAddress: CONTRACT_ADDRESS }];

          setStatus(ui.decryptStatus, "Calling Relayer for userDecrypt…");
          const result = await relayer.userDecrypt(
            pairs,
            keypair.privateKey,
            keypair.publicKey,
            sig.replace("0x", ""),
            [CONTRACT_ADDRESS],
            account,
            startTs,
            daysValid
          );

          // Handle key mismatch quirks
          let value = result[handle];
          if (value === undefined) {
            const key = Object.keys(result).find(
              (k) => k.toLowerCase() === String(handle).toLowerCase()
            );
            if (key) value = result[key];
          }

          if (value === undefined) {
            throw new Error("Relayer returned no value for this handle.");
          }

          const ageNum = Number(value);
          if (!Number.isFinite(ageNum)) {
            throw new Error("Decryption returned a non-numeric value: " + String(value));
          }

          ui.ageValue.textContent = ageNum.toString();
          ui.ageDisplay.style.display = "inline-flex";
          setStatus(ui.decryptStatus, "Age decrypted locally. Only you see this value.", "ok");
        } catch (e) {
          log.err("decryptMyAge error:", e);
          setStatus(ui.decryptStatus, e.message || String(e), "err");
          ui.ageDisplay.style.display = "none";
        }
      }

      ui.btnDecryptAge.addEventListener("click", () => {
        decryptMyAge();
      });

      // ---------- Owner: make specific player age public ----------
      async function ownerMakeAgePublic() {
        try {
          if (!contract || !isOwner) await connectWallet();
          const addr = ui.ownerTarget.value.trim();
          if (!addr) throw new Error("Enter a player address.");

          setStatus(ui.ownerStatus, "Submitting makePlayerAgePublic()…");
          const tx = await contract.makePlayerAgePublic(addr);
          log.info("makePlayerAgePublic tx:", tx.hash);
          await tx.wait();
          setStatus(ui.ownerStatus, "Player age marked as public.", "ok");
        } catch (e) {
          log.err("ownerMakeAgePublic error:", e);
          setStatus(ui.ownerStatus, e.message || String(e), "err");
        }
      }

      ui.btnOwnerMakePublic.addEventListener("click", () => {
        ownerMakeAgePublic();
      });

      // ---------- Owner: clear player profile ----------
      async function ownerClearProfile() {
        try {
          if (!contract || !isOwner) await connectWallet();
          const addr = ui.ownerTarget.value.trim();
          if (!addr) throw new Error("Enter a player address.");

          setStatus(ui.ownerStatus, "Submitting clearPlayer()…");
          const tx = await contract.clearPlayer(addr);
          log.info("clearPlayer tx:", tx.hash);
          await tx.wait();
          setStatus(ui.ownerStatus, "Player profile cleared logically.", "ok");
        } catch (e) {
          log.err("ownerClearProfile error:", e);
          setStatus(ui.ownerStatus, e.message || String(e), "err");
        }
      }

      ui.btnOwnerClear.addEventListener("click", () => {
        ownerClearProfile();
      });

      // Initial labels
      ui.networkLabel.textContent = "Sepolia · not connected";
    </script>
  </body>
</html>
